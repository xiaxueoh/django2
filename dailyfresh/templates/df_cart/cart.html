{%extends 'base.html'%}


{%block head%}
<script type="text/javascript" src="/static/js/jquery-1.12.4.min.js"></script>
<script>
    //get 请求  通过拼凑字符串来实现这个功能
     function doget() {
         url = '/order/?';
	    $('.cart_list_td').each(function () {
	        if(($(this).find('li:first-child')).children().prop('checked')){
	            url += 'carts_id='+$(this).attr('id')+'&';
			}

        });

	    if (url == '/order/?'){
	        confirm('当前购物车为空，请添加商品');
		}else {
	        url = url.slice(0, -1);
	        location.href=url;
		}

     }




	// 小计/总计
	function total() {


		every_total = 0;
		global_total = 0;
		total_count = 0;
		$('.col07').each(function () {
			qty = parseFloat($(this).prev().find('input').val());
			price = parseFloat($(this).prev().prev().text());
		    every_total = qty*price;
		    $(this).text(every_total.toFixed(2));
		    global_total += every_total;
		    total_count ++;

        });
		   $('#total').text(global_total.toFixed(2));
           $('.total_count1').text(total_count);

	}

		//删除某条购物车数据
		function cart_del(cart_id){
	        del = confirm('确认要删除吗？');
	        if(del){
	            $.get('/cart/dele'+cart_id+'/', function (data) {
					if (data.ok == 0){
						$('ul').remove('#' + cart_id);
						total();
					}
           		 });
			}

		}



    $(function () {

        //调用小计/总计
        total();


        // 利用绑定事件的方式来做，因为无法用选择器来定位到具体的位置
		// 加一运算
        $('.add').each(function () {
			$(this).bind('click', function () {
				num = parseFloat($(this).next('.num_show').val());
				$(this).next('.num_show').val(num+1);
				$(this).blur();
				$(this).next('.num_show').blur();

            });
        });


        // 减一运算
		$('.minus').each(function () {
			$(this).bind('click', function () {
				num1 = parseInt($(this).prev('.num_show').val());
				if(num1 >= 2){
				    num1 -= 1;
					$(this).prev('.num_show').val(num1);
					$(this).blur();
					$(this).prev('.num_show').blur();
				}else {
				    $(this).prev('.num_show').val('1');
				    $(this).blur();
				    $(this).prev('.num_show').blur();
				}
            });
        });


		// 文本框输入
		$('.num_show').each(function () {
		    $(this).bind('blur',function () {
				num2 = parseFloat($(this).val());
				if (num2 >= 1){
				    $(this).val(num2);
				}else{
				    $(this).val('1');
				}

				//修改数据库数量
				cart_id = $(this).parents('.cart_list_td').attr('id');
				goods_count = $(this).val();

				$.get('/cart/edit'+cart_id+'_'+goods_count+'/', function (data) {
					if(data.ok == 0){
                       total();
					}else {
						$(this).val(goods_count);
					}

                });

            });
        });

        // 全选.全消
		$('#check_all').click(function () {
            state = $(this).prop('checked');
            $(':checkbox:not(#check_all)').prop('checked', state);
        });

		// 选择
		$(':checkbox:not(#check_all)').click(function () {
		    if($(this).prop('checked')){
		        if($(':checked').length+1==$(':checkbox').length){
		            $('#check_all').prop('checked', true);
				}
			}else{
				$('#check_all').prop('checked', false);
			}
        });
	});

</script>



{%endblock head%}
{%block body%}
	<div class="total_count">全部商品<em class="total_count1"></em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>
	{%for cart in carts%}

	<ul class="cart_list_td clearfix" id="{{cart.id}}">
		<li class="col01"><input type="checkbox" name="" checked></li>
		<li class="col02"><img src="/static/{{cart.goods.gpic}}"></li>
		<li class="col03">{{cart.goods.gtitle}}<br><em>{{cart.goods.gprice}}元/{{cart.goods.gunit}}</em><br><em style="font-size: 13px; color: orangered">库存：{{cart.goods.gkucun}}</em></li>
		<li class="col04">{{cart.goods.gunit}}</li>
		<li class="col05">{{cart.goods.gprice}}</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl" >+</a>
				<input type="text" class="num_show fl" value="{{cart.ctoun}}">
				<a href="javascript:;" class="minus fl" >-</a>
			</div>
		</li>
		<li class="col07">{{cart.goods.gprice}}</li>
		<li class="col08"><a href="javascript:cart_del({{cart.id}});" >删除</a></li>
	</ul>
    {%endfor%}



	<ul class="settlements">
		<li class="col01" ><input id="check_all" type="checkbox" name="" checked=""></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em id="total"></em><br>共计<b class="total_count1"></b>件商品</li>
		<li class="col04"><a href="javascript:doget();">去结算</a></li>
	</ul>

{%endblock body%}